"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getFrameMessage = exports.getHubClient = void 0;
const hub_nodejs_1 = require("@farcaster/hub-nodejs");
const farcasterTypes_1 = require("./farcasterTypes");
/**
 * Farcaster Hub for signature verification,
 * consider using a private hub if needed:
 * https://docs.farcaster.xyz/hubble/hubble
 */
const HUB_URL = 'nemes.farcaster.xyz:2283';
function getHubClient() {
    return (0, hub_nodejs_1.getSSLHubRpcClient)(HUB_URL);
}
exports.getHubClient = getHubClient;
/**
 * Given a frame message, decode and validate it.
 *
 * If message is valid, return the message. Otherwise undefined.
 *
 * @param body The JSON received by server on frame callback
 */
async function getFrameMessage(body) {
    // Get the message from the request body
    const frameMessage = hub_nodejs_1.Message.decode(Buffer.from(body?.trustedData?.messageBytes ?? '', 'hex'));
    // Validate the message
    const client = getHubClient();
    const result = await client.validateMessage(frameMessage);
    if (result.isOk() && result.value.valid && result.value.message) {
        return {
            isValid: result.value?.valid,
            message: (0, farcasterTypes_1.convertToFrame)(result?.value?.message?.data),
        };
    }
    return {
        isValid: false,
        message: undefined,
    };
}
exports.getFrameMessage = getFrameMessage;
//# sourceMappingURL=getFrameMessage.js.map